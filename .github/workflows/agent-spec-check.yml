name: Agent spec check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e '.[dev]'
          # requests is used by scripts/check_agent_spec.py; ensure it's available in the runner
          pip install requests

      - name: Run agent-spec check (enforced)
        id: agent_spec_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -o pipefail
          python scripts/check_agent_spec.py --pr ${{ github.event.pull_request.number }}

      - name: Post failure comment when missing specs
        if: ${{ failure() }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request && context.payload.pull_request.number ? context.payload.pull_request.number : undefined;
            if (!pr) return;
            const message = `‚ùå Agent spec check failed: agent code changes require a matching agent spec attached under AGENTS/. If this is intentional, add the label **allow-agent-without-spec** to the PR or set the environment variable **AGENT_SAFETY_IGNORE_SPEC=1** in the workflow (requires maintainer approval). Otherwise please add a filled agent spec and re-run the workflow. See docs/SECURITY_REVIEW.md for details.`;
            // use the REST client API for comments
            await github.rest.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: pr, body: message});
